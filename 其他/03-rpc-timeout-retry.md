# RPC 超时设置和重试策略

## 背景
很多产品上线后，伴随着需求迭代，技术上也进行了服务化改造。  

在服务化的过程中，很多同学关于微服务之间的RPC超时设置和重试策略不太合理，给服务的稳定性埋下了隐患。比如
- 上游超时时间过短，下游经常报499
- 上游超时时间过长，上游资源耗尽，导致雪崩
- 上游重试策略不合理，比如调用链A->B->C，其中B调C失败重试，重试失败后A调B又重试，引起C过载，导致雪崩

> 具体例子请自行 google 或 百度

## 优化方案
### 关于超时时间
- 超时时间精确到毫秒
- 建议分开配置 conn_timeout 和 read_timeout，一般 conn_timeout 小于 read_timeout：
1.conn_timeout 值根据网络情况，建议值 50ms-200ms
2.read_timeout 值需下游给出建议，根据建议值控制在 100ms-1000ms
- 特殊情况下，为MIS定制的API可能耗时较长，超时时间可适当延长，但建议控制在1500ms，大于该值应该考虑的是下游的改造优化，而不是粗暴地增加上游的超时时长
- 最糟糕的情况，下游耗时长且无法优化，比如跨部门、跨公司的服务调用，同步调用改成异步调用，超时时间根据下游建议值设置，同时异步处理时做好流控，避免占用过多资源

### 关于超时策略
- 调用链A->B->C，B调C失败不重试，直接返回，是否重试由A控制
- 调用失败后，避免不必要的超时，建议直接报错让用户触发重试，如必须重试则1次即可。
> 一般情况下，如果下游服务异常或网络问题，短时间内重试成功的概率很低

## 后话
关于超时设置和重试策略，前老板的话犹在耳畔：**你要是口渴了，别人给你一瓶毒药你喝吗？**