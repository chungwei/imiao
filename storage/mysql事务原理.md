# 概述
作为一名处于一线开发的工程师，MySQL是我最常用的存储，理解MySQL事务的实现原理是相当有必要的。
那么，问题就来了：
- 数据库事务是什么？
- 数据库事务的原理是什么？
- 以哪个切入点去学习？

__个人认为，理解数据库事务的原理，本质上就是理解数据库事务特性的实现过程。__

所以，我们从数据库事务特性开始。

# 事务原理
数据库事务是数据库管理系统执行过程中的一个逻辑单位，由一个有限的数据库操作序列构成。
事务有四个特性，分别是原子性(Atomicity)、一致性(Consistency)、 隔离性(Isolation)、持久性(Durability)，即ACID。理解事务的实现原理，从理解事务的特性开始。

## 示例
事务1
```
# A给B转账100元
SELECT * FROM tb WHERE user='A'; 
UPDATE tb SET amount=amout-100 WHERE user='A';
SELECT * FROM tb WHERE user='B';
UPDATE tb SET amount=amout+100 WHERE user='B';
```

## 原子性
### 概念
事务是一个不可分割的整体，事务开始后要么全部做完要么全部不做，不可能停滞在中间环节。如执行出错则回滚到事务开始前的状态，所有的操作就像没有发生一样。

> 其侧重点是事务执行的完整，确保每一步的执行都是成功的，如果有一步失败，那整体失败。如`事务1`，必须是A扣钱B加钱同时成功或者失败。
### 实现
依赖`undo log`。
要保证事务的原子性，就需要在异常发生时，对已经执行的操作进行回滚，在 MySQL 中，恢复机制是通过`undo log`实现的，*所有事务进行的修改都会先记录到`undo log`中，然后再对数据库中的数据进行写入*。如`事务1`，实现步骤是：
1. 事务开始
1. 读记录A到内存
1. 写记录A到`undo log`缓冲区
1. 内存中更新记录A`amount`字段，即减钱
1. 读记录B到内存
1. 写记录B到`undo log`缓冲区
1. 内存中更新记录B`amount`字段，即加钱
1. 将`undo log`顺序写入磁盘
1. 提交事务
> 这里只说明原子性，其他不相关操作暂时忽略  

在此过程中，任何一步操作发生异常，事务通过回滚`undo log`；或者当时系统崩溃、再次重启时，立刻通过查询`undo log`将之前未完成的事务进行回滚,以实现原子性。

## 持久性
### 概念
事务提交成功后，所有的修改保存在数据库中不可改变或丢失，即使是系统或介质发生故障也不可改变或丢失。

### 实现
依赖`redo log`。
它由两部分组成，一是内存中的`redo log`缓冲区，在内存中易丢失；另一个就是在磁盘上的`redo log`，它是持久的。
如`事务1`，实现步骤是：
1. 事务开始
1. 读记录A到内存
1. 内存中更新记录A`amount`字段，即减钱
1. 记录A变更写到`redo log`缓冲区
1. 读记录B到内存
1. 内存中更新记录B`amount`字段，即加钱
1. 记录B变更写到`redo log`缓冲区
1. 将`redo log`顺序写入磁盘
1. 提交事务
> 这里只说明持久性，其他不相关操作暂时忽略  

在事务提交后，数据没来得及写磁盘就宕机时，在下次重新启动后能够成功恢复数据，以实现持久性。

>> `undo log` 和 `redo log` 是成对出现的，统称`transaction log`。

## 隔离性
多个事务并发访问时，事务之间是隔离的，一个事务不应该影响其它事务运行效果。

隔离级别          | 脏读 | 幻读 | 不可重复读 |
-----------------|-----|-----|----------|
Serializable     |  x  |  x  |    x     |
Repeatable read  |  x  |  √  |    x     |
Read committed   |  x  |  √  |    √     |
Read uncommitted |  √  |  √  |    √     |


## 一致性
### 概念
事务执行之前和执行之后，数据库的状态一定是一致的。
> 其侧重点是事务按照预期生效，可以认为事务的其他特性都是为了实现一致性。如`事务1`，执行之前AB的总金额是200元，那么执行之后AB的总金额也必须是200元，假如A扣钱成功B没加钱，那就是不一致的状态，。

### 实现


# 参看文献
1. [百度百科-数据库事务](https://baike.baidu.com/item/%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BA%8B%E5%8A%A1)
1. []()
1. []()
1. []()
1. []()
1. []()
1. []()
